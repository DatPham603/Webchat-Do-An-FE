<div class="app-container d-flex vh-100">
  <aside class="left-sidebar bg-light d-flex flex-column align-items-center p-3" style="width: 80px">
    <div class="user-profile mb-3">
      <img [src]="avatarUrl || 'https://via.placeholder.com/100'" alt="Avatar" style="
          width: 80px;
          height: 80px;
          border-radius: 50%;
          object-fit: cover;
          margin-right: 10px;
        " />
    </div>
    <nav class="navigation">
      <ul class="nav flex-column align-items-center">
        <li class="nav-item active mb-2">
          <a class="nav-link text-center"><i class="bi bi-chat-fill fs-5"></i></a>
        </li>
        <li class="nav-item mb-2">
          <a class="nav-link text-center"><i class="bi bi-bell-fill fs-5"></i></a>
        </li>
        <li class="nav-item">
          <a class="nav-link text-center"><i class="bi bi-gear-fill fs-5"></i></a>
        </li>
      </ul>
    </nav>
  </aside>

  <section class="chats-section flex-grow-0 d-flex flex-column border-end" style="width: 380px">
    <div class="chats-header p-3 d-flex justify-content-between align-items-center">
      <h2 class="h5 mb-0">Chats</h2>
      <button class="btn btn-sm btn-outline-secondary rounded-circle" (click)="openCreateGroupModal()">
        <i class="bi bi-plus"></i>
      </button>
    </div>
    <div class="search-bar p-3">
      <div class="input-group">
        <input type="text" class="form-control form-control-sm"
          placeholder="Tìm kiếm người dùng theo email/số điện thoại" [(ngModel)]="searchTerm" (keyup.enter)="findUserByEmailOrPhoneNumber()" />
        <button class="btn btn-outline-secondary btn-sm" type="button" (click)="findUserByEmailOrPhoneNumber()">
          <i class="bi bi-search"></i>
        </button>
      </div>
      <div *ngIf="foundUserToAdd" class="mt-2 small d-flex align-items-center justify-content-between">
        <div  class="member-item d-flex align-items-center mb-2 small clickable"
         (click)="openFriendInfoModal(foundUserToAdd.id)">
          <div class="avatar rounded-circle me-2" style="
            width: 25px;
            height: 25px;
            background-color: #ddd;
            overflow: hidden;
            ">
            <img [src]="
              foundUserToAdd.avatar
                ? 'http://localhost:8989/api/v1/users/avatar/get-avatar/' + getFilenameFromUrl(foundUserToAdd.avatar)
                : 'path/to/default-avatar.png'
            " alt="{{ foundUserToAdd.userName }}" class="avatar-sm img-fluid rounded-circle " style="border: none; object-fit: cover" />
          </div>
          <span>{{ foundUserToAdd.userName }}</span>
        </div>
        <button class="btn btn-sm btn-primary ms-2">Kết bạn</button>
        <!-- thêm sự kiện click vào đây để kết bạn -->
      </div>
      <div *ngIf="findUserError" class="mt-2 text-danger small">
        {{ findUserError }}
      </div>
    </div>
    <div class="chats-tabs p-2">
      <div class="btn-group w-100 btn-group-sm" role="group">
        <button type="button" class="btn btn-light active">Chat</button>
        <button type="button" class="btn btn-light">Call</button>
      </div>
    </div>
    <ul class="chats-list list-unstyled overflow-auto">
      <li *ngFor="let item of chatList" (click)="selectChat(item)" [class.active]="
          (selectedFriendId === item.id && item.type === 'user') ||
          (selectedGroupId === item.id && item.type === 'group')
        " class="p-2 border-bottom d-flex align-items-center" style="cursor: pointer">
        <div class="avatar rounded-circle me-2" style="
            width: 35px;
            height: 35px;
            background-color: #ddd;
            object-fit: cover;
          ">
          <img *ngIf="item.type === 'user'" [src]="item.avatarUrl" alt="{{ item.name }}" class="avatar-sm img-fluid rounded-circle" style="border: none; object-fit: cover" />
          <img *ngIf="item.type === 'group'" [src]="item.avatarUrl" alt="{{ item.name }}" class="avatar-sm img-fluid rounded-circle" style="border: none; object-fit: cover" />
        </div>
        <div class="info flex-grow-1">
          <span class="d-block fw-bold small">{{ item.name }}</span>
          <p class="text-muted small text-truncate mb-0">
            <span *ngIf="item.type === 'user'">{{
              item.lastMessage || "No messages yet"
              }}</span>
            <span *ngIf="item.type === 'group'">{{
              item.lastMessage || "No messages yet"
              }}</span>

              <!-- nếu item.contentype == 'file' thì hiển thị tên file -->
            <!-- <span *ngIf="item.contentType === 'group'">{{
                "file"
                }}</span> -->
          </p>
          <span *ngIf="item.type === 'group'" class="text-muted small">({{ item.memberCount }} members)</span>
        </div>
        <span class="text-muted small ms-auto">{{
          item.lastActive | date : "shortTime"
          }}</span>
      </li>
    </ul>
  </section>

  <section class="chat-area flex-grow-2 d-flex flex-column">
    <div class="chat-area-header p-3 border-bottom d-flex justify-content-between align-items-center">
      <div class="recipient-info d-flex align-items-center">
        <div class="avatar rounded-circle me-2" style="
            width: 35px;
            height: 35px;
            background-color: #ddd;
            object-fit: cover;">
          <div class="avatar rounded-circle me-2" style="
              width: 35px;
              height: 35px;
              background-color: #ddd;
              overflow: hidden;
            " *ngIf="selectedFriendId" >
            <img *ngIf="selectedFriendAvatarUrl" [src]="selectedFriendAvatarUrl" alt="{{ selectedFriend?.friendName }}"
              class="avatar-sm img-fluid rounded-circle" style="border: none" />
            <img *ngIf="!selectedFriendAvatarUrl && selectedFriend?.avatar" src="path/to/default/avatar.png"
              alt="{{ selectedFriend?.friendName }}" class=" avatar-sm img-fluid rounded-circle" style="border: none" />
            <img *ngIf="!selectedFriend?.avatar && !selectedFriendAvatarUrl" src="path/to/default/avatar.png"
              alt="Default Avatar" class="avatar-sm img-fluid rounded-circle" style="border: none" />
          </div>
          <div class="avatar rounded-circle me-2" style="
              width: 35px;
              height: 35px;
              background-color: #ddd;
              overflow: hidden;
            " *ngIf="selectedGroupId" >
            <img [src]="groupAvatarUrl" alt="{{ selectedFriend?.friendName }}"
              class="avatar-sm img-fluid rounded-circle" style="border: none" />
            
          </div>
        </div>
        <span class="fw-bold small" *ngIf="selectedFriendId">{{selectedFriend.friendName}}</span>
        <span class="fw-bold small" *ngIf="selectedGroupId">{{selectedGroupName}}</span>
      </div>
      <div class="chat-actions">
        <button *ngIf="selectedFriendId" class="btn btn-sm btn-outline-secondary rounded-circle me-2"
          (click)="startCall(selectedFriendId)">
          <i class="bi bi-telephone-fill"></i>
        </button>
        <button class="btn btn-sm btn-outline-secondary rounded-circle">
          <i class="bi bi-three-dots-vertical"></i>
        </button>
      </div>
    </div>
    <div #chatContainer class="messages flex-grow-1 overflow-auto p-3">
      <div *ngFor="let message of messages" class="mb-2 d-flex" [ngClass]="{
          'justify-content-end': message.senderId === userId,
          'justify-content-start': message.senderId !== userId
        }">
        <div class="message-content p-2 rounded-pill d-inline-block" [ngClass]="{
            'bg-primary text-white': message.senderId === userId && message.contentType !== 'IMAGE',
            'bg-light text-dark': message.senderId !== userId && message.contentType !== 'IMAGE'}"
          style="max-width: 70%">
          <p class="mb-0 small" *ngIf="message.contentType === 'TEXT'">
            {{ message.content }}
          </p>
          <img *ngIf="message.contentType === 'IMAGE' && message.fileUrl" [src]="
              'http://localhost:8990/api/v1/file/get-image/' +
              getFilenameFromUrl(message.fileUrl)" (click)="zoomImage(
                    'http://localhost:8990/api/v1/file/get-image/' + getFilenameFromUrl(message.fileUrl)
                  )" alt="Image" style="
              max-width: 400px;
              height: auto;
              border: none;
              background-color: transparent;
              cursor: pointer; 
            " />
          <a *ngIf="message.contentType === 'FILE' && message.fileUrl" [href]="
              'http://localhost:8990/api/v1/file/download/' +
              getFilenameFromUrl(message.fileUrl)
            " target="_blank" class="text-decoration-none">
            <button class="btn btn-sm rounded-pill" [ngClass]="{
                'btn-light text-dark': message.senderId !== userId,
                'btn-white text-white': message.senderId === userId
              }">
              <i class="bi bi-file-earmark-fill me-1"></i> {{getOriginFilenameFromUrl(message.fileUrl)}}
            </button>
          </a>
        </div>
        <span class="sender-info small text-muted ms-1 me-1 align-self-end" [ngClass]="{
            'text-end': message.senderId === userId,
            'text-start': message.senderId !== userId
          }">
          {{
          message.senderId === userId ? "Bạn": friendMap[message.senderId] || message.createdDate }}
          <!-- sửa lại thành date? -->
        </span>
      </div>
    </div>
    <div class="message-input-area p-3 border-top">
      <div class="d-flex flex-column">
        <div *ngIf="isFilePending && selectedFile" class="pending-file mb-2 d-flex align-items-center">
          <div *ngIf="selectedImageUrl" class="image-preview me-2" style="max-width: 50px; max-height: 50px; overflow: hidden;">
            <img [src]="selectedImageUrl" alt="Preview" style="width: 100%; height: auto;">
          </div>
          <div *ngIf="!selectedImageUrl" class="file-info me-2">
            <i class="bi bi-file-earmark-fill me-1"></i> {{ selectedFile.name }}
          </div>
          <button class="btn btn-sm btn-outline-danger rounded-circle" (click)="cancelPendingFile()">
            <i class="bi bi-x-lg"></i>
          </button>
        </div>
    
        <div class="d-flex align-items-center">
          <div class="input-actions me-2">
            <button class="btn btn-sm btn-light rounded-circle me-1">
              <i class="bi bi-plus"></i>
            </button>
            <input type="file" (change)="onFileSelected($event)" style="display: none" #fileInput />
            <button class="btn btn-sm btn-light rounded-circle me-1" (click)="fileInput.click()">
              <i class="bi bi-paperclip"></i>
            </button>
            <input type="file" accept="image/*" (change)="onImageSelected($event)" style="display: none" #imageInput />
            <button class="btn btn-sm btn-light rounded-circle me-1" (click)="imageInput.click()">
              <i class="bi bi-image-fill"></i>
            </button>
            <button class="btn btn-sm btn-light rounded-circle">
              <i class="bi bi-emoji-smile-fill"></i>
            </button>
          </div>
          <div class="input-field flex-grow-1 me-2">
            <input type="text" class="form-control form-control-sm rounded-pill" [(ngModel)]="messageInput"
              placeholder="Viết tin nhắn..." (keyup.enter)="sendMessage()" />
          </div>
          <div class="send-button">
            <button class="btn btn-primary btn-sm rounded-pill" (click)="sendMessage()">
              <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>


  <aside class="right-sidebar bg-light border-start p-3" style="width: 350px">
    <div *ngIf="selectedGroupId" class="profile-info mb-3 d-flex flex-column align-items-center position-relative">
      <div class="position-relative">
        <img
          [src]="groupAvatarUrl || 'https://via.placeholder.com/50'"
          alt="{{ selectedGroupName }}"
          class="img-fluid rounded-circle"
          style="width: 80px; height: 80px; border: none; object-fit: cover;"
        />
        <ng-container *ngIf="isEditingGroupAvatar; else viewGroupAvatarUpload">
          <div class="d-flex align-items-center mt-2">
            <input
              type="file"
              class="form-control form-control-sm"
              accept="image/png, image/jpeg, image/gif"
              (change)="onAvatarSelected($event)"
              #groupAvatarInputRef
            />
          </div>
            <button class="btn btn-sm btn-secondary mt-2" (click)="clearAvatarSelection()">
              <i class="bi bi-x"></i> Hủy
            </button>
            <button *ngIf="groupAvatarFile" class="btn btn-sm btn-primary mt-2" (click)="uploadGroupAvatar()">
            <i class="bi bi-upload"></i> Tải lên
          </button>
        </ng-container>
        <ng-template #viewGroupAvatarUpload>
          <div
            class="position-absolute bottom-0 end-0 bg-success rounded-circle d-flex justify-content-center align-items-center"
            style="width: 24px; height: 24px; cursor: pointer;"
            (click)="isEditingGroupAvatar = true"
          >
            <i class="bi bi-pencil-fill text-white small"></i>
          </div>
        </ng-template>
      </div>
      <h3 class="h6 mt-2 mb-0 text-center">{{ selectedGroupName }}</h3>
    </div>



    <div *ngIf="selectedFriendId" class="profile-info mb-3 d-flex flex-column align-items-center">
      <div class="avatar rounded-circle" style="
          width: 80px; height: 80px; border: none; object-fit: cover;
        ">
        <img *ngIf="selectedFriendAvatarUrl" [src]="selectedFriendAvatarUrl" alt="{{ selectedFriend?.friendName }}"
          class="img-fluid rounded-circle" style="border: none" />
        <img *ngIf="!selectedFriendAvatarUrl && selectedFriend?.avatar" src="path/to/default/avatar.png"
          alt="{{ selectedFriend?.friendName }}" class="img-fluid rounded-circle" style="border: none" />
        <img *ngIf="!selectedFriend?.avatar && !selectedFriendAvatarUrl" src="path/to/default/avatar.png"
          alt="Default Avatar" class="img-fluid rounded-circle" style="border: none" />
      </div>
      <h3 class="h6 mt-2 mb-0">{{ selectedFriend?.friendName }}</h3>
    </div>

    <div class="settings mb-3">
      <div class="setting-item d-flex justify-content-between align-items-center mb-2 small">
        <span>Thông báo</span>
        <div class="form-check form-switch">
          <input class="form-check-input form-check-input-sm" type="checkbox" role="switch" />
        </div>
      </div>
      <div class="setting-item d-flex justify-content-between align-items-center mb-2 small">
        <span>Âm thanh</span>
        <div class="form-check form-switch">
          <input class="form-check-input form-check-input-sm" type="checkbox" role="switch" />
        </div>
      </div>
      <div class="setting-item d-flex justify-content-between align-items-center mb-2 small">
        <span>Lưu vào tải xuống</span>
        <div class="form-check form-switch">
          <input class="form-check-input form-check-input-sm" type="checkbox" role="switch" />
        </div>
      </div>
    </div>

    <div class="members" *ngIf="selectedGroupId">
      <div class="members-header d-flex justify-content-between align-items-center mb-2 small">
        <span class="fw-bold">Thành viên</span>
        <button class="btn btn-sm btn-outline-secondary" (click)="openAddMemberModal()">
          Thêm thành viên
        </button>
      </div>
      <div *ngIf="groupMembers.length > 0" class="members-list overflow-auto" style="max-height: 200px">
        <div *ngFor="let member of groupMembers" class="member-item d-flex align-items-center mb-2 small clickable"
          (click)="openFriendInfoModal(member.id)">
          <div class="avatar rounded-circle me-2" style="
                width: 25px;
                height: 25px;
                background-color: #ddd;
                overflow: hidden;
              ">
            <img [src]="
                  member.avatar
                    ? 'http://localhost:8989/api/v1/users/avatar/get-avatar/' + getFilenameFromUrl(member.avatar)
                    : 'path/to/default-avatar.png'
                " alt="{{ member.userName }}" class="img-fluid rounded-circle" style="border: none" />
          </div>
          <span>{{ member.userName }}</span>
        </div>
      </div>
    </div>

    <div class="members" *ngIf="selectedFriendId"></div>

    <hr>

    <div class="media-links mt-3">
      <div class="d-flex justify-content-around small">
        <button class="btn btn-sm btn-light choose-file-btn" [class.selected-tab]="showMediaSection"
          (click)="showMedia()">Ảnh</button>
        <button class="btn btn-sm btn-light choose-file-btn" [class.selected-tab]="showDocsSection"
          (click)="showDocs()">Files</button>
      </div>

      <div *ngIf="showMediaSection" class="media-section mt-2">
        <div class="image-gallery">
          <div *ngFor="let image of imageList" class="image-item">
            <img [src]="'http://localhost:8990/api/v1/file/get-image/' + getFilenameFromUrl(image.fileUrl)"
              alt="Ảnh chat" (click)="zoomImage(
            'http://localhost:8990/api/v1/file/get-image/' + getFilenameFromUrl(image.fileUrl)
          )" style="max-width: 150px; height: auto; margin: 5px; border: 1px solid #ccc; border-radius: 5px;">
          </div>
          <div *ngIf="imageList.length === 0" class="text-muted small">
            Không có ảnh nào trong cuộc trò chuyện này.
          </div>
        </div>
      </div>
      <div *ngIf="showDocsSection" class="docs-section mt-2">
        <ul class="list-unstyled doc-gallery">
          <li *ngFor="let doc of docList" class="doc-item p-2 border-bottom small">
            <i class="bi bi-file-earmark-fill me-2"></i>
            <a [href]="'http://localhost:8990/api/v1/file/download/' + getFilenameFromUrl(doc.fileUrl)" target="_blank"
              class="text-decoration-none text-dark">{{ getOriginFilenameFromUrl(doc.fileUrl) }}</a>
          </li>
          <li *ngIf="docList.length === 0" class="text-muted small">
            Không có tài liệu nào trong cuộc trò chuyện này.
          </li>
        </ul>
      </div>
    </div>
  </aside>

  <audio #remoteAudio autoplay></audio>

  <div *ngIf="isCalling" class="call-overlay bg-secondary text-white p-3 rounded small">
    Đang gọi với {{ friendMap[callInProgressWith!] || callInProgressWith }}...
    <button (click)="stopCall()" class="btn btn-danger btn-sm ms-2">
      Kết thúc
    </button>
  </div>

  <div *ngIf="isIncomingCall" class="incoming-call-overlay bg-success text-white p-3 rounded small">
    Cuộc gọi đến từ {{ incomingCallerName }}
    <button (click)="acceptCall()" class="btn btn-primary btn-sm me-2">
      Chấp nhận
    </button>
    <button (click)="rejectCall()" class="btn btn-danger btn-sm">
      Từ chối
    </button>
  </div>
</div>

<div *ngIf="isAddMemberModalOpen" class="modal fade show" style="display: block; background-color: rgba(0, 0, 0, 0.5)">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Thêm thành viên vào nhóm</h5>
        <button type="button" class="btn-close" (click)="closeAddMemberModal()"></button>
      </div>

      <div class="modal-body">
        <h6>Tìm kiếm theo email</h6>
        <div class="input-group mb-2">
          <input type="text" style="width: 0; margin-bottom: 0" class="search-group-user form-control form-control-sm"
            placeholder="Tìm kiếm người dùng theo email" [(ngModel)]="searchEmail" />
          <button class="btn btn-outline-secondary btn-sm" type="button" (click)="findUserByEmail()">
            <i class="bi bi-search"></i>
          </button>
        </div>
        <div *ngIf="foundUser" class="mt-2 small d-flex align-items-center justify-content-between">
          <span>{{ foundUser.userName }}</span>
          <button class="btn btn-sm btn-primary" (click)="addUserToGroup()">
            Thêm
          </button>
        </div>
        <div *ngIf="findUserError" class="mt-2 text-danger small">
          {{ findUserError }}
        </div>

        <hr />

        <h6>Danh sách bạn bè</h6>
        <ul *ngIf="potentialGroupMembers.length > 0" class="list-unstyled overflow-auto" style="max-height: 150px">
          <li *ngFor="let friend of potentialGroupMembers"
            class="d-flex align-items-center justify-content-between mb-1 small">
            <span>{{ friend.friendName }}</span>
            <button class="btn btn-sm btn-primary" (click)="addUserToGroupFromFriend(friend.friendEmail)">
              Thêm
            </button>
          </li>
        </ul>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" (click)="closeAddMemberModal()">
          Đóng
        </button>
      </div>
    </div>
  </div>
</div>

<div *ngIf="zoomedImageUrl" class="image-zoom-overlay" (click)="closeZoom()">
  <img [src]="zoomedImageUrl" class="zoomed-image" [alt]="'Ảnh phóng to'" />
</div>

<div *ngIf="isCreateGroupModalOpen" class="modal fade show"
  style="display: block; background-color: rgba(0, 0, 0, 0.5)">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Tạo nhóm mới</h5>
        <button type="button" class="btn-close" (click)="closeCreateGroupModal()"></button>
      </div>
      <div class="modal-body">
        <input type="text" [(ngModel)]="newGroupName" class="form-control form-control-sm mb-2"
          placeholder="Tên nhóm" />
        <button class="btn btn-primary btn-sm" (click)="createGroup()">
          Tạo
        </button>
        <button class="btn btn-secondary btn-sm ms-2" (click)="closeCreateGroupModal()">
          Hủy
        </button>
      </div>
    </div>
  </div>
</div>

<friend-infor *ngIf="isFriendInfoModalOpen" [userId]="selectedGroupFriendId" (closeModal)="closeFriendInfoModal()"
  style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  ">
  <div class="card" style="max-width: 600px; margin: 0 auto;">
  </div>
</friend-infor>